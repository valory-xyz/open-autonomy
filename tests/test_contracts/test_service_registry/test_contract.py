# -*- coding: utf-8 -*-
# ------------------------------------------------------------------------------
#
#   Copyright 2022 Valory AG
#
#   Licensed under the Apache License, Version 2.0 (the "License");
#   you may not use this file except in compliance with the License.
#   You may obtain a copy of the License at
#
#       http://www.apache.org/licenses/LICENSE-2.0
#
#   Unless required by applicable law or agreed to in writing, software
#   distributed under the License is distributed on an "AS IS" BASIS,
#   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#   See the License for the specific language governing permissions and
#   limitations under the License.
#
# ------------------------------------------------------------------------------

"""Tests for valory/service_registry contract."""

# To test locally, run a hardhat node:
# docker run -p 8545:8545 -it valory/consensus-algorithms-hardhat:0.1.0


import logging
from typing import Dict, List, Tuple, Any, cast
from pathlib import Path
from aea.test_tools.test_contract import BaseContractTestCase

from tests.test_contracts.base import BaseContractTest, BaseHardhatAMMContractTest
# from aea.test_tools.test_contract import BaseContractTestCase

from aea_ledger_ethereum import EthereumCrypto
from packages.valory.contracts.service_registry.contract import (
    PUBLIC_ID,
    ServiceRegistryContract,
)
from unittest import mock
from tests.conftest import ROOT_DIR
# from tests.helpers.contracts import get_register_contract
from web3 import Web3
# from aea_ledger_ethereum import EthereumApi
from tests.test_contracts.base import BaseGanacheContractTest

Address = hex
ConfigHash = tuple
AgentParams = List[tuple]

DEPLOYED_BYTECODE = "0x6080604052600436106102d55760003560e01c806376626b2211610179578063a3fbbaae116100d6578063c87b56dd1161008a578063e23f6fb411610064578063e23f6fb414610895578063e985e9c5146108a8578063f2fde38b146108f1576102f3565b8063c87b56dd14610842578063ccc9305d14610862578063d30d5c1214610882576102f3565b8063a9fb763c116100bb578063a9fb763c146107ef578063aac18bd914610802578063b88d4fde14610822576102f3565b8063a3fbbaae14610798578063a5d059ca146107b8576102f3565b8063922b7abe1161012d5780639b875b77116101125780639b875b771461072a578063a22cb46514610758578063a24835d114610778576102f3565b8063922b7abe146106e757806395d89b4114610715576102f3565b806382a8ea581161015e57806382a8ea58146106725780638a2bd86f146106a95780638da5cb5b146106c9576102f3565b806376626b221461061e578063772a367114610652576102f3565b80632f745c59116102325780634f6ccce7116101e65780636f99f15c116101c05780636f99f15c146105d357806370a08231146105e9578063715018a614610609576102f3565b80634f6ccce7146105735780635419bb8c146105935780636352211e146105b3576102f3565b806342842e0e1161021757806342842e0e146104ff578063490b7a791461051f5780634f558e7914610553576102f3565b80632f745c591461049e57806340c2b69f146104be576102f3565b80630d1cfcae1161028957806321e4f7bb1161026e57806321e4f7bb1461043057806323b872dd1461045e57806329d8ef251461047e576102f3565b80630d1cfcae146103dd57806318160ddd14610411576102f3565b8063081812fc116102ba578063081812fc146103635780630901ca141461039b578063095ea7b3146103bb576102f3565b806301ffc9a71461030c57806306fdde0314610341576102f3565b366102f357604051630afc5a5160e41b815260040160405180910390fd5b604051630afc5a5160e41b815260040160405180910390fd5b34801561031857600080fd5b5061032c61032736600461586b565b610911565b60405190151581526020015b60405180910390f35b34801561034d57600080fd5b50610356610955565b6040516103389190615c99565b34801561036f57600080fd5b5061038361037e3660046158bf565b6109e7565b6040516001600160a01b039091168152602001610338565b3480156103a757600080fd5b5061032c6103b6366004615586565b610a81565b3480156103c757600080fd5b506103db6103d6366004615666565b610ef0565b005b3480156103e957600080fd5b506103837f000000000000000000000000e7f1725e7734ce288f8367e1bb143e90bb3f051281565b34801561041d57600080fd5b506009545b604051908152602001610338565b34801561043c57600080fd5b5061045061044b366004615976565b611022565b604051610338929190615cac565b34801561046a57600080fd5b506103db6104793660046153c6565b611180565b34801561048a57600080fd5b50610383610499366004615691565b611207565b3480156104aa57600080fd5b506104226104b9366004615666565b6114de565b3480156104ca57600080fd5b506104f26104d93660046158bf565b6000908152600f60208190526040909120015460ff1690565b6040516103389190615c71565b34801561050b57600080fd5b506103db61051a3660046153c6565b611586565b34801561052b57600080fd5b506103837f00000000000000000000000090f79bf6eb2c4f870365e785982e1f101e93b90681565b34801561055f57600080fd5b5061032c61056e3660046158bf565b6115a1565b34801561057f57600080fd5b5061042261058e3660046158bf565b6115c0565b34801561059f57600080fd5b5061032c6105ae3660046157e5565b611672565b3480156105bf57600080fd5b506103836105ce3660046158bf565b611944565b3480156105df57600080fd5b50610422600d5481565b3480156105f557600080fd5b50610422610604366004615372565b6119cf565b34801561061557600080fd5b506103db611a69565b34801561062a57600080fd5b506103837f0000000000000000000000003c44cdddb6a900fa2b585dd299e03d12fa4293bc81565b34801561065e57600080fd5b5061042261066d3660046154b0565b611acf565b34801561067e57600080fd5b5061069261068d3660046158bf565b611d08565b6040516103389b9a99989796959493929190615ad2565b3480156106b557600080fd5b506104226106c4366004615666565b6120dc565b3480156106d557600080fd5b506000546001600160a01b0316610383565b3480156106f357600080fd5b506107076107023660046158bf565b612142565b604051610338929190615cde565b34801561072157600080fd5b50610356612217565b34801561073657600080fd5b5061074a6107453660046158bf565b612226565b604051610338929190615d51565b34801561076457600080fd5b506103db610773366004615483565b61228a565b34801561078457600080fd5b5061032c610793366004615666565b612299565b3480156107a457600080fd5b506103db6107b3366004615372565b61243e565b3480156107c457600080fd5b506107d86107d3366004615666565b6124ba565b604080519215158352602083019190915201610338565b6104226107fd3660046158bf565b612916565b34801561080e57600080fd5b5061074a61081d3660046158bf565b612a2b565b34801561082e57600080fd5b506103db61083d366004615406565b612a8d565b34801561084e57600080fd5b5061035661085d3660046158bf565b612b1b565b34801561086e57600080fd5b506107d861087d366004615666565b612c11565b61032c610890366004615774565b612f50565b61032c6108a3366004615666565b613598565b3480156108b457600080fd5b5061032c6108c336600461538e565b6001600160a01b03918216600090815260066020908152604080832093909416825291909152205460ff1690565b3480156108fd57600080fd5b506103db61090c366004615372565b6137c6565b60006001600160e01b031982167f780e9d6300000000000000000000000000000000000000000000000000000000148061094f575061094f826138a8565b92915050565b60606001805461096490615e76565b80601f016020809104026020016040519081016040528092919081815260200182805461099090615e76565b80156109dd5780601f106109b2576101008083540402835291602001916109dd565b820191906000526020600020905b8154815290600101906020018083116109c057829003601f168201915b5050505050905090565b6000818152600360205260408120546001600160a01b0316610a655760405162461bcd60e51b815260206004820152602c60248201527f4552433732313a20617070726f76656420717565727920666f72206e6f6e657860448201526b34b9ba32b73a103a37b5b2b760a11b60648201526084015b60405180910390fd5b506000908152600560205260409020546001600160a01b031690565b600e546000906001600160a01b03163314610ac457600e5460405163312d21ff60e11b81523360048201526001600160a01b039091166024820152604401610a5c565b88826001600160a01b0382161580610af157506000818152600360205260409020546001600160a01b0316155b80610b165750816001600160a01b0316610b0a82611944565b6001600160a01b031614155b15610b3757604051636cf2027b60e01b815260048101829052602401610a5c565b6000848152600f602052604090206001600f82015460ff166006811115610b6e57634e487b7160e01b600052602160045260246000fd5b14610bbe57600f81015460ff166006811115610b9a57634e487b7160e01b600052602160045260246000fd5b604051633c053f9d60e21b8152600481019190915260248101869052604401610a5c565b610bcb8b8b8b8b8b613943565b6000885167ffffffffffffffff811115610bf557634e487b7160e01b600052604160045260246000fd5b604051908082528060200260200182016040528015610c1e578160200160208202803683370190505b5090506000895167ffffffffffffffff811115610c4b57634e487b7160e01b600052604160045260246000fd5b604051908082528060200260200182016040528015610c9057816020015b6040805180820190915260008082526020820152815260200190600190039081610c695790505b5090506000805b8b51811015610dea578a8181518110610cc057634e487b7160e01b600052603260045260246000fd5b60200260200101516000015160001415610d225784600b0160008d8381518110610cfa57634e487b7160e01b600052603260045260246000fd5b6020908102919091018101518252810191909152604001600090812081815560010155610dd8565b8b8181518110610d4257634e487b7160e01b600052603260045260246000fd5b6020026020010151848381518110610d6a57634e487b7160e01b600052603260045260246000fd5b6020026020010181815250508a8181518110610d9657634e487b7160e01b600052603260045260246000fd5b6020026020010151838381518110610dbe57634e487b7160e01b600052603260045260246000fd5b60200260200101819052508180610dd490615eb1565b9250505b80610de281615eb1565b915050610c97565b50610df9600a85016000615068565b8b51600685018054610e0d90600190615e33565b81548110610e2b57634e487b7160e01b600052603260045260246000fd5b90600052602060002090600202016000015414610e8f576006840180546001818101835560009283526020928390208f51600290930201918255918e01519101805460408f015160ff9081166101000261ffff199092169316929092179190911790555b610e9e848f8f8c878787613bec565b7f3b6d9b8cf9767363ab370f8631a32e3a7d78516f151e3cf1bcf3fb5b11b431608f8f8b8b604051610ed39493929190615bd3565b60405180910390a15060019e9d5050505050505050505050505050565b6000610efb82611944565b9050806001600160a01b0316836001600160a01b03161415610f855760405162461bcd60e51b815260206004820152602160248201527f4552433732313a20617070726f76616c20746f2063757272656e74206f776e6560448201527f72000000000000000000000000000000000000000000000000000000000000006064820152608401610a5c565b336001600160a01b0382161480610fa15750610fa181336108c3565b6110135760405162461bcd60e51b815260206004820152603860248201527f4552433732313a20617070726f76652063616c6c6572206973206e6f74206f7760448201527f6e6572206e6f7220617070726f76656420666f7220616c6c00000000000000006064820152608401610a5c565b61101d8383613e7f565b505050565b60008281526003602052604081205460609084906001600160a01b031661105f5760405163f036789160e01b815260048101829052602401610a5c565b6000858152600f60209081526040808320878452600c81019092529091205493508367ffffffffffffffff8111156110a757634e487b7160e01b600052604160045260246000fd5b6040519080825280602002602001820160405280156110d0578160200160208202803683370190505b50925060005b84811015611176576000868152600c83016020526040902080548290811061110e57634e487b7160e01b600052603260045260246000fd5b9060005260206000200160009054906101000a90046001600160a01b031684828151811061114c57634e487b7160e01b600052603260045260246000fd5b6001600160a01b03909216602092830291909101909101528061116e81615eb1565b9150506110d6565b5050509250929050565b61118a3382613eed565b6111fc5760405162461bcd60e51b815260206004820152603160248201527f4552433732313a207472616e736665722063616c6c6572206973206e6f74206f60448201527f776e6572206e6f7220617070726f7665640000000000000000000000000000006064820152608401610a5c565b61101d838383613fe4565b600e546000906001600160a01b0316331461124a57600e5460405163312d21ff60e11b81523360048201526001600160a01b039091166024820152604401610a5c565b8a8a6001600160a01b038216158061127757506000818152600360205260409020546001600160a01b0316155b8061129c5750816001600160a01b031661129082611944565b6001600160a01b031614155b156112bd57604051636cf2027b60e01b815260048101829052602401610a5c565b60008c8152600f602052604090206003600f82015460ff1660068111156112f457634e487b7160e01b600052602160045260246000fd5b1461134457600f81015460ff16600681111561132057634e487b7160e01b600052602160045260246000fd5b604051633c053f9d60e21b81526004810191909152602481018e9052604401610a5c565b600061134f826141bc565b90506113c4604051806101200160405280606081526020016000815260200160006001600160a01b031681526020016060815260200160006001600160a01b0316815260200160006001600160a01b031681526020016000815260200160006001600160a01b03168152602001600081525090565b81815260078301546020808301919091526001600160a01b038f166040808401919091528051601f8f018390048302810183019091528d8152908e908e908190840183828082843760009201919091525050505060608201526001600160a01b03808c1660808301528a811660a083015260c082018a9052881660e0820152610100810187905261145481614334565b95507f9ba9bf5098181d9a47cace9784f4e3710d21f1d2540e73a7d47aaab9439c7ecb8f83856007015460405161148d93929190615cc5565b60405180910390a161149e8f6144b5565b50506003810180546001600160a01b0386166001600160a01b0319909116179055600f01805460ff1916600417905550909b9a5050505050505050505050565b60006114e9836119cf565b821061155d5760405162461bcd60e51b815260206004820152602b60248201527f455243373231456e756d657261626c653a206f776e657220696e646578206f7560448201527f74206f6620626f756e64730000000000000000000000000000000000000000006064820152608401610a5c565b506001600160a01b03919091166000908152600760209081526040808320938352929052205490565b61101d83838360405180602001604052806000815250612a8d565b6000818152600360205260408120546001600160a01b0316151561094f565b60006115cb60095490565b821061163f5760405162461bcd60e51b815260206004820152602c60248201527f455243373231456e756d657261626c653a20676c6f62616c20696e646578206f60448201527f7574206f6620626f756e647300000000000000000000000000000000000000006064820152608401610a5c565b6009828154811061166057634e487b7160e01b600052603260045260246000fd5b90600052602060002001549050919050565b60008181526003602052604081205482906001600160a01b03166116ac5760405163f036789160e01b815260048101829052602401610a5c565b83518551146116db57845184516040516351f67da160e11b815260048101929092526024820152604401610a5c565b6000838152600f6020526040902060038101546001600160a01b0316331461174d5760038101546040517f79f91cd30000000000000000000000000000000000000000000000000000000081523360048201526001600160a01b03909116602482015260448101859052606401610a5c565b855160005b81811015611936576000601060008a848151811061178057634e487b7160e01b600052603260045260246000fd5b6020908102919091018101516001600160a01b039081168352828201939093526040918201600090812054909316808452600e880190915291205489519192509081908a90859081106117e357634e487b7160e01b600052603260045260246000fd5b6020026020010151106118115780600d60008282546118029190615de8565b90915550600091506118879050565b88838151811061183157634e487b7160e01b600052603260045260246000fd5b6020026020010151600d600082825461184a9190615de8565b9250508190555088838151811061187157634e487b7160e01b600052603260045260246000fd5b6020026020010151816118849190615e33565b90505b6001600160a01b0382166000908152600e86016020526040902081905588517fa2e524bd0f71903485fbb3d6d50cb305f61005ceea2047c3ac92aa7e0d104306908a90859081106118e857634e487b7160e01b600052603260045260246000fd5b6020026020010151838a60405161191b939291909283526001600160a01b03919091166020830152604082015260600190565b60405180910390a150508061192f90615eb1565b9050611752565b506001979650505050505050565b6000818152600360205260408120546001600160a01b03168061094f5760405162461bcd60e51b815260206004820152602960248201527f4552433732313a206f776e657220717565727920666f72206e6f6e657869737460448201527f656e7420746f6b656e00000000000000000000000000000000000000000000006064820152608401610a5c565b60006001600160a01b038216611a4d5760405162461bcd60e51b815260206004820152602a60248201527f4552433732313a2062616c616e636520717565727920666f7220746865207a6560448201527f726f2061646472657373000000000000000000000000000000000000000000006064820152608401610a5c565b506001600160a01b031660009081526004602052604090205490565b6000546001600160a01b03163314611ac35760405162461bcd60e51b815260206004820181905260248201527f4f776e61626c653a2063616c6c6572206973206e6f7420746865206f776e65726044820152606401610a5c565b611acd6000614726565b565b600e546000906001600160a01b03163314611b1257600e5460405163312d21ff60e11b81523360048201526001600160a01b039091166024820152604401610a5c565b6001600160a01b038816611b52576040517fd92e233d00000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b611b5f8787878787613943565b60005b8451811015611c1957838181518110611b8b57634e487b7160e01b600052603260045260246000fd5b60200260200101516000015160001480611bd05750838181518110611bc057634e487b7160e01b600052603260045260246000fd5b6020026020010151602001516000145b15611c07576040517f7c946ed700000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b80611c1181615eb1565b915050611b62565b50600c8054906000611c2a83615eb1565b9091555050600c546000818152600f6020908152604080832060068101805460018181018355918652948490208b51600290960201948555928a0151939092018054918a015160ff9081166101000261ffff1990931694169390931717909155855191925090611ca59082908a908a9087908a908a90613bec565b611caf8983614776565b600f8101805460ff191660011790556040517feaa3e48609d3060c7aaa154c27b78fafc59d92ed248276ace8e79aa3c36092f790611cf4908b908b9087908790615bd3565b60405180910390a150979650505050505050565b60408051606081810183526000808352602083018190529282018390529081906000806060806000606060008b611d56816000908152600360205260409020546001600160a01b0316151590565b611d765760405163f036789160e01b815260048101829052602401610a5c565b60008d8152600f60205260409020600a81015467ffffffffffffffff811115611daf57634e487b7160e01b600052604160045260246000fd5b604051908082528060200260200182016040528015611df457816020015b6040805180820190915260008082526020820152815260200190600190039081611dcd5790505b50955080600901549450611e07816141bc565b935060005b600a820154811015611eb75781600b01600083600a018381548110611e4157634e487b7160e01b600052603260045260246000fd5b9060005260206000200154815260200190815260200160002060405180604001604052908160008201548152602001600182015481525050878281518110611e9957634e487b7160e01b600052603260045260246000fd5b60200260200101819052508080611eaf90615eb1565b915050611e0c565b50611ec18e611944565b9c50806004018054611ed290615e76565b80601f0160208091040260200160405190810160405280929190818152602001828054611efe90615e76565b8015611f4b5780601f10611f2057610100808354040283529160200191611f4b565b820191906000526020600020905b815481529060010190602001808311611f2e57829003601f168201915b50505050509b50806005018054611f6190615e76565b80601f0160208091040260200160405190810160405280929190818152602001828054611f8d90615e76565b8015611fda5780601f10611faf57610100808354040283529160200191611fda565b820191906000526020600020905b815481529060010190602001808311611fbd57829003601f168201915b5050506006840154929d50600092611ff6925060019150615e33565b905081600601818154811061201b57634e487b7160e01b600052603260045260246000fd5b6000918252602091829020604080516060810182526002909302909101805483526001015460ff8082168486015261010090910416828201526007850154600a86018054835181870281018701909452808452939f50909d50919b50918b908301828280156120a957602002820191906000526020600020905b815481526020019060010190808311612095575b505050505097508160030160009054906101000a90046001600160a01b0316935050505091939597999b90929496989a50565b60008181526003602052604081205482906001600160a01b03166121165760405163f036789160e01b815260048101829052602401610a5c565b50506000908152600f602090815260408083206001600160a01b039094168352600e9093019052205490565b60008181526003602052604081205460609083906001600160a01b031661217f5760405163f036789160e01b815260048101829052602401610a5c565b6000848152600f6020908152604080832060068101805483518186028101860190945280845291949193909291839185919084015b8282101561220657600084815260209081902060408051606081018252600286029092018054835260019081015460ff80821685870152610100909104169183019190915290835290920191016121b4565b505050509050935093505050915091565b60606002805461096490615e76565b6000818152601260209081526040808320805482518185028101850190935280835260609383018282801561227a57602002820191906000526020600020905b815481526020019060010190808311612266575b5050505050905080519150915091565b612295338383614790565b5050565b600e546000906001600160a01b031633146122dc57600e5460405163312d21ff60e11b81523360048201526001600160a01b039091166024820152604401610a5c565b82826001600160a01b038216158061230957506000818152600360205260409020546001600160a01b0316155b8061232e5750816001600160a01b031661232282611944565b6001600160a01b031614155b1561234f57604051636cf2027b60e01b815260048101829052602401610a5c565b6000848152600f602052604090206006600f82015460ff16600681111561238657634e487b7160e01b600052602160045260246000fd5b141580156123bb57506001600f82015460ff1660068111156123b857634e487b7160e01b600052602160045260246000fd5b14155b156123e757600f81015460ff166006811115610b9a57634e487b7160e01b600052602160045260246000fd5b6123f08561485f565b604080516001600160a01b0388168152602081018790527fbabd5b766777e228ce586bda23024f76f3a2f32e12decdd1643b3720d4fbc9ab910160405180910390a150600195945050505050565b6000546001600160a01b031633146124985760405162461bcd60e51b815260206004820181905260248201527f4f776e61626c653a2063616c6c6572206973206e6f7420746865206f776e65726044820152606401610a5c565b600e80546001600160a01b0319166001600160a01b0392909216919091179055565b600e5460009081906001600160a01b031633146124ff57600e5460405163312d21ff60e11b81523360048201526001600160a01b039091166024820152604401610a5c565b6002600b5414156125525760405162461bcd60e51b815260206004820152601f60248201527f5265656e7472616e637947756172643a207265656e7472616e742063616c6c006044820152606401610a5c565b6002600b556000838152600f602052604090206005600f82015460ff16600681111561258e57634e487b7160e01b600052602160045260246000fd5b146125de57600f81015460ff1660068111156125ba57634e487b7160e01b600052602160045260246000fd5b604051633c053f9d60e21b8152600481019190915260248101859052604401610a5c565b6001600160a01b0385166000908152600d82016020908152604080832080548251818502810185019093528083529192909190849084015b8282101561265e576000848152602090819020604080518082019091526002850290910180546001600160a01b03168252600190810154828401529083529092019101612616565b505082519293505050806126b0576040517fdf2ddd730000000000000000000000000000000000000000000000000000000081526001600160a01b038816600482015260248101879052604401610a5c565b808360090160008282546126c49190615e33565b909155505060098301546126e257600f8301805460ff191660061790555b6000935060005b818110156127aa5783600b01600084838151811061271757634e487b7160e01b600052603260045260246000fd5b602002602001015160200151815260200190815260200160002060010154856127409190615de8565b94506010600084838151811061276657634e487b7160e01b600052603260045260246000fd5b602090810291909101810151516001600160a01b0316825281019190915260400160002080546001600160a01b0319169055806127a281615eb1565b9150506126e9565b506001600160a01b0387166000908152600e84016020526040902054808511156127d2578094505b841561287c576001600160a01b0388166000818152600e860160205260408082208290555190919087908381818185875af1925050503d8060008114612834576040519150601f19603f3d011682016040523d82523d6000602084013e612839565b606091505b505090508061287a5760405163cd3f165960e01b8152600060048201523060248201526001600160a01b038a16604482015260648101879052608401610a5c565b505b604080516001600160a01b038a168152602081018790527fbb28353e4598c3b9199101a66e0989549b659a59a54d2c27fbb183f1932c8e6d910160405180910390a1604080516001600160a01b038a168152602081018990527f5ebf7fe30be09f0f03b9195632508d95c8b67bf010c93abda67f70d5d9599d1e91015b60405180910390a150506001600b81905596929550919350505050565b60008181526003602052604081205482906001600160a01b03166129505760405163f036789160e01b815260048101829052602401610a5c565b6002600b5414156129a35760405162461bcd60e51b815260206004820152601f60248201527f5265656e7472616e637947756172643a207265656e7472616e742063616c6c006044820152606401610a5c565b6002600b556000838152600f602052604090206001015491506129c63483615de8565b6000848152600f602052604090819020600101829055519092507f635942c16b465bb759dcd6a2b2b98d73feb4b77e60e601a258a354d876a94b7f90612a189085903490918252602082015260400190565b60405180910390a1506001600b55919050565b6000818152601160209081526040808320805482518185028101850190935280835260609383018282801561227a5760200282019190600052602060002090815481526020019060010190808311612266575050505050905080519150915091565b612a973383613eed565b612b095760405162461bcd60e51b815260206004820152603160248201527f4552433732313a207472616e736665722063616c6c6572206973206e6f74206f60448201527f776e6572206e6f7220617070726f7665640000000000000000000000000000006064820152608401610a5c565b612b1584848484614906565b50505050565b6000818152600360205260409020546060906001600160a01b0316612ba85760405162461bcd60e51b815260206004820152602f60248201527f4552433732314d657461646174613a2055524920717565727920666f72206e6f60448201527f6e6578697374656e7420746f6b656e00000000000000000000000000000000006064820152608401610a5c565b6000612bbf60408051602081019091526000815290565b90506000815111612bdf5760405180602001604052806000815250612c0a565b80612be984614984565b604051602001612bfa929190615a35565b6040516020818303038152906040525b9392505050565b600e5460009081906001600160a01b03163314612c5657600e5460405163312d21ff60e11b81523360048201526001600160a01b039091166024820152604401610a5c565b83836001600160a01b0382161580612c8357506000818152600360205260409020546001600160a01b0316155b80612ca85750816001600160a01b0316612c9c82611944565b6001600160a01b031614155b15612cc957604051636cf2027b60e01b815260048101829052602401610a5c565b6002600b541415612d1c5760405162461bcd60e51b815260206004820152601f60248201527f5265656e7472616e637947756172643a207265656e7472616e742063616c6c006044820152606401610a5c565b6002600b556000858152600f602052604090206001600f82015460ff166006811115612d5857634e487b7160e01b600052602160045260246000fd5b1480612d8a57506005600f82015460ff166006811115612d8857634e487b7160e01b600052602160045260246000fd5b145b80612dbb57506006600f82015460ff166006811115612db957634e487b7160e01b600052602160045260246000fd5b145b15612e0b57600f81015460ff166006811115612de757634e487b7160e01b600052602160045260246000fd5b604051633c053f9d60e21b8152600481019190915260248101879052604401610a5c565b600981015415612e2957600f8101805460ff19166005179055612e39565b600f8101805460ff191660061790555b80546040519094506000906001600160a01b0389169086908381818185875af1925050503d8060008114612e89576040519150601f19603f3d011682016040523d82523d6000602084013e612e8e565b606091505b5050905080612ecf5760405163cd3f165960e01b8152600060048201523060248201526001600160a01b038916604482015260648101869052608401610a5c565b604080516001600160a01b038a168152602081018790527fbb28353e4598c3b9199101a66e0989549b659a59a54d2c27fbb183f1932c8e6d910160405180910390a1604080516001600160a01b038a168152602081018990527f4b129b8c1cdc29ce3eccd3294658699d802a89981b7425b46b5bb5d37546db3191016128f9565b600e546000906001600160a01b03163314612f9357600e5460405163312d21ff60e11b81523360048201526001600160a01b039091166024820152604401610a5c565b6002600b541415612fe65760405162461bcd60e51b815260206004820152601f60248201527f5265656e7472616e637947756172643a207265656e7472616e742063616c6c006044820152606401610a5c565b6002600b55815183511461301a57825182516040516351f67da160e11b815260048101929092526024820152604401610a5c565b6000848152600f602052604090206002600f82015460ff16600681111561305157634e487b7160e01b600052602160045260246000fd5b1461307d57600f81015460ff166006811115610b9a57634e487b7160e01b600052602160045260246000fd5b83516000805b828110156131465760008682815181106130ad57634e487b7160e01b600052603260045260246000fd5b6020026020010151905084600b0160008281526020019081526020016000206000015460001415613114576040517fca0caf9400000000000000000000000000000000000000000000000000000000815260048101829052602481018a9052604401610a5c565b6000818152600b860160205260409020600101546131329084615de8565b9250508061313f90615eb1565b9050613083565b50803414613190576040517ffd7795720000000000000000000000000000000000000000000000000000000081523460048201526024810182905260448101889052606401610a5c565b60005b828110156134f45760008782815181106131bd57634e487b7160e01b600052603260045260246000fd5b6020026020010151905060008783815181106131e957634e487b7160e01b600052603260045260246000fd5b60200260200101519050816001600160a01b03168b6001600160a01b0316148061322c57506001600160a01b038b81166000908152601060205260409020541615155b15613266576040517f8b77af64000000000000000000000000000000000000000000000000000000008152600481018b9052602401610a5c565b6001600160a01b0382811660009081526010602052604090205416156132d6576001600160a01b03828116600090815260106020526040908190205490517f631695bd00000000000000000000000000000000000000000000000000000000815291166004820152602401610a5c565b6000818152600b87016020908152604080832054600c8a01909252909120541415613330576040517f12b4401c000000000000000000000000000000000000000000000000000000008152600481018b9052602401610a5c565b85600c016000828152602001908152602001600020829080600181540180825580915050600190039060005260206000200160009091909190916101000a8154816001600160a01b0302191690836001600160a01b0316021790555085600d0160008c6001600160a01b03166001600160a01b031681526020019081526020016000206040518060400160405280846001600160a01b0316815260200183815250908060018154018082558091505060019003906000526020600020906002020160009091909190915060008201518160000160006101000a8154816001600160a01b0302191690836001600160a01b0316021790555060208201518160010155505085600901600081548092919061344890615eb1565b90915550506001600160a01b03808316600090815260106020526040908190208054928e166001600160a01b031990931692909217909155517f6835389a6da5341647f18cbe0a89c56f473f4c17bfaee6e6d07d61f1928e0b7c906134d9908d908d90869086906001600160a01b039485168152602081019390935292166040820152606081019190915260800190565b60405180910390a15050806134ed90615eb1565b9050613193565b5082600801548360090154141561351557600f8301805460ff191660031790555b6001600160a01b0388166000908152600e840160205260408120805434929061353f908490615de8565b9091555050604080516001600160a01b038a1681523460208201527fe1fffcc4923d04b559f4d29a8bfc6cda04eb5b0d3c460751c2402c5c5cc9109c910160405180910390a150506001600b8190559695505050505050565b600e546000906001600160a01b031633146135db57600e5460405163312d21ff60e11b81523360048201526001600160a01b039091166024820152604401610a5c565b82826001600160a01b038216158061360857506000818152600360205260409020546001600160a01b0316155b8061362d5750816001600160a01b031661362182611944565b6001600160a01b031614155b1561364e57604051636cf2027b60e01b815260048101829052602401610a5c565b6002600b5414156136a15760405162461bcd60e51b815260206004820152601f60248201527f5265656e7472616e637947756172643a207265656e7472616e742063616c6c006044820152606401610a5c565b6002600b556000848152600f602052604090206001600f82015460ff1660068111156136dd57634e487b7160e01b600052602160045260246000fd5b14613717576040517fb2c1a45e00000000000000000000000000000000000000000000000000000000815260048101869052602401610a5c565b805434146137645780546040517fe1855dd8000000000000000000000000000000000000000000000000000000008152346004820152602481019190915260448101869052606401610a5c565b600f8101805460ff19166002179055604080516001600160a01b0388168152602081018790527f1ce3906173019d252d1f9e5e788bf566ad4e79446f16b12ab17ff51344cda922910160405180910390a150506001600b819055949350505050565b6000546001600160a01b031633146138205760405162461bcd60e51b815260206004820181905260248201527f4f776e61626c653a2063616c6c6572206973206e6f7420746865206f776e65726044820152606401610a5c565b6001600160a01b03811661389c5760405162461bcd60e51b815260206004820152602660248201527f4f776e61626c653a206e6577206f776e657220697320746865207a65726f206160448201527f64647265737300000000000000000000000000000000000000000000000000006064820152608401610a5c565b6138a581614726565b50565b60006001600160e01b031982167f80ac58cd00000000000000000000000000000000000000000000000000000000148061390b57506001600160e01b031982167f5b5e139f00000000000000000000000000000000000000000000000000000000145b8061094f57507f01ffc9a7000000000000000000000000000000000000000000000000000000006001600160e01b031983161461094f565b8451158061395057508351155b15613987576040517fecd7b0d100000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b826020015160ff1660121415806139a65750826040015160ff16602014155b15613a045760208381015160408086015190517f76916ba500000000000000000000000000000000000000000000000000000000815260ff928316600482015260126024820152911660448201526064810191909152608401610a5c565b81511580613a1457508051825114155b15613a3f57815181516040516351f67da160e11b815260048101929092526024820152604401610a5c565b6000805b8351811015613be35781848281518110613a6d57634e487b7160e01b600052603260045260246000fd5b6020026020010151111580613b4457507f000000000000000000000000e7f1725e7734ce288f8367e1bb143e90bb3f05126001600160a01b0316634f558e79858381518110613acc57634e487b7160e01b600052603260045260246000fd5b60200260200101516040518263ffffffff1660e01b8152600401613af291815260200190565b60206040518083038186803b158015613b0a57600080fd5b505afa158015613b1e573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190613b42919061584f565b155b15613ba657838181518110613b6957634e487b7160e01b600052603260045260246000fd5b60200260200101516040517faac42c2c000000000000000000000000000000000000000000000000000000008152600401610a5c91815260200190565b838181518110613bc657634e487b7160e01b600052603260045260246000fd5b602002602001015191508080613bdb90615eb1565b915050613a43565b50505050505050565b8551613c019060048901906020890190615086565b508451613c179060058901906020880190615086565b5060078701849055600060088801819055805b82811015613dac5788600a01858281518110613c5657634e487b7160e01b600052603260045260246000fd5b602090810291909101810151825460018101845560009384529190922001558351849082908110613c9757634e487b7160e01b600052603260045260246000fd5b602002602001015189600b016000878481518110613cc557634e487b7160e01b600052603260045260246000fd5b602002602001015181526020019081526020016000206000820151816000015560208201518160010155905050838181518110613d1257634e487b7160e01b600052603260045260246000fd5b602002602001015160000151896008016000828254613d319190615de8565b9250508190555081848281518110613d5957634e487b7160e01b600052603260045260246000fd5b6020026020010151602001511115613d9a57838181518110613d8b57634e487b7160e01b600052603260045260246000fd5b60200260200101516020015191505b80613da481615eb1565b915050613c2a565b508088556008880154600090613dc3906002615e14565b613dce906001615de8565b9050613ddb600382615ecc565b613df157613dea600382615e00565b9050613e0a565b613dfc600382615e00565b613e07906001615de8565b90505b8089600701541080613e23575088600801548960070154115b15613e7457600789015460088a01546040517feb3a8ba30000000000000000000000000000000000000000000000000000000081526004810192909252602482018390526044820152606401610a5c565b505050505050505050565b600081815260056020526040902080546001600160a01b0319166001600160a01b0384169081179091558190613eb482611944565b6001600160a01b03167f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b92560405160405180910390a45050565b6000818152600360205260408120546001600160a01b0316613f665760405162461bcd60e51b815260206004820152602c60248201527f4552433732313a206f70657261746f7220717565727920666f72206e6f6e657860448201526b34b9ba32b73a103a37b5b2b760a11b6064820152608401610a5c565b6000613f7183611944565b9050806001600160a01b0316846001600160a01b03161480613fac5750836001600160a01b0316613fa1846109e7565b6001600160a01b0316145b80613fdc57506001600160a01b0380821660009081526006602090815260408083209388168352929052205460ff165b949350505050565b826001600160a01b0316613ff782611944565b6001600160a01b0316146140735760405162461bcd60e51b815260206004820152602560248201527f4552433732313a207472616e736665722066726f6d20696e636f72726563742060448201527f6f776e65720000000000000000000000000000000000000000000000000000006064820152608401610a5c565b6001600160a01b0382166140ee5760405162461bcd60e51b8152602060048201526024808201527f4552433732313a207472616e7366657220746f20746865207a65726f2061646460448201527f72657373000000000000000000000000000000000000000000000000000000006064820152608401610a5c565b6140f9838383614ad2565b614104600082613e7f565b6001600160a01b038316600090815260046020526040812080546001929061412d908490615e33565b90915550506001600160a01b038216600090815260046020526040812080546001929061415b908490615de8565b909155505060008181526003602052604080822080546001600160a01b0319166001600160a01b0386811691821790925591518493918716917fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef91a4505050565b6060816009015467ffffffffffffffff8111156141e957634e487b7160e01b600052604160045260246000fd5b604051908082528060200260200182016040528015614212578160200160208202803683370190505b5090506000805b600a84015481101561432d57600084600a01828154811061424a57634e487b7160e01b600052603260045260246000fd5b9060005260206000200154905060005b6000828152600c87016020526040902054811015614318576000828152600c8701602052604090208054829081106142a257634e487b7160e01b600052603260045260246000fd5b9060005260206000200160009054906101000a90046001600160a01b03168585815181106142e057634e487b7160e01b600052603260045260246000fd5b6001600160a01b03909216602092830291909101909101528361430281615eb1565b945050808061431090615eb1565b91505061425a565b5050808061432590615eb1565b915050614219565b5050919050565b60008063b63e800d60e01b836000015184602001518560400151866060015187608001518860a001518960c001518a60e0015160405160240161437e989796959493929190615c08565b60408051601f198184030181529181526020820180517bffffffffffffffffffffffffffffffffffffffffffffffffffffffff166001600160e01b03199094169390931790925261010085015191517f1688f0b90000000000000000000000000000000000000000000000000000000081529092507f00000000000000000000000090f79bf6eb2c4f870365e785982e1f101e93b906916000916001600160a01b03841691631688f0b99161445a917f0000000000000000000000003c44cdddb6a900fa2b585dd299e03d12fa4293bc91889190600401615a64565b602060405180830381600087803b15801561447457600080fd5b505af1158015614488573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906144ac91906158a3565b95945050505050565b6000818152600f60205260408120905b600a82015481101561101d57600082600a0182815481106144f657634e487b7160e01b600052603260045260246000fd5b600091825260208083209190910154808352601182526040808420805460018101825590855292842090920187905590517f661a0d0b000000000000000000000000000000000000000000000000000000008152600481018290529092507f000000000000000000000000e7f1725e7734ce288f8367e1bb143e90bb3f05126001600160a01b03169063661a0d0b9060240160006040518083038186803b1580156145a057600080fd5b505afa1580156145b4573d6000803e3d6000fd5b505050506040513d6000823e601f3d908101601f191682016040526145dc91908101906158d7565b91505060005b815181101561471057600082828151811061460d57634e487b7160e01b600052603260045260246000fd5b6020026020010151905060006012600083815260200190815260200160002080548060200260200160405190810160405280929190818152602001828054801561467657602002820191906000526020600020905b815481526020019060010190808311614662575b5050505050905060005b81518110156146cf57888282815181106146aa57634e487b7160e01b600052603260045260246000fd5b602002602001015114156146bd576146cf565b806146c781615eb1565b915050614680565b81518114156146fa576000838152601260209081526040822080546001810182559083529120018990555b505050808061470890615eb1565b9150506145e2565b505050808061471e90615eb1565b9150506144c5565b600080546001600160a01b038381166001600160a01b0319831681178455604051919092169283917f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e09190a35050565b612295828260405180602001604052806000815250614b8a565b816001600160a01b0316836001600160a01b031614156147f25760405162461bcd60e51b815260206004820152601960248201527f4552433732313a20617070726f766520746f2063616c6c6572000000000000006044820152606401610a5c565b6001600160a01b03838116600081815260066020908152604080832094871680845294825291829020805460ff191686151590811790915591519182527f17307eab39ab6107e8899845ad3d59bd9653f200f220920489ca2b5937696c31910160405180910390a3505050565b600061486a82611944565b905061487881600084614ad2565b614883600083613e7f565b6001600160a01b03811660009081526004602052604081208054600192906148ac908490615e33565b909155505060008281526003602052604080822080546001600160a01b0319169055518391906001600160a01b038416907fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef908390a45050565b614911848484613fe4565b61491d84848484614c08565b612b155760405162461bcd60e51b815260206004820152603260248201527f4552433732313a207472616e7366657220746f206e6f6e20455243373231526560448201527131b2b4bb32b91034b6b83632b6b2b73a32b960711b6064820152608401610a5c565b6060816149c457505060408051808201909152600181527f3000000000000000000000000000000000000000000000000000000000000000602082015290565b8160005b81156149ee57806149d881615eb1565b91506149e79050600a83615e00565b91506149c8565b60008167ffffffffffffffff811115614a1757634e487b7160e01b600052604160045260246000fd5b6040519080825280601f01601f191660200182016040528015614a41576020820181803683370190505b5090505b8415613fdc57614a56600183615e33565b9150614a63600a86615ecc565b614a6e906030615de8565b60f81b818381518110614a9157634e487b7160e01b600052603260045260246000fd5b60200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916908160001a905350614acb600a86615e00565b9450614a45565b6001600160a01b038316614b2d57614b2881600980546000838152600a60205260408120829055600182018355919091527f6e1540171b6c0c960b71a7020d9f60077f6af931a8bbf590da0223dacf75c7af0155565b614b50565b816001600160a01b0316836001600160a01b031614614b5057614b508382614d60565b6001600160a01b038216614b675761101d81614dfd565b826001600160a01b0316826001600160a01b03161461101d5761101d8282614ed6565b614b948383614f1a565b614ba16000848484614c08565b61101d5760405162461bcd60e51b815260206004820152603260248201527f4552433732313a207472616e7366657220746f206e6f6e20455243373231526560448201527131b2b4bb32b91034b6b83632b6b2b73a32b960711b6064820152608401610a5c565b60006001600160a01b0384163b15614d5557604051630a85bd0160e11b81526001600160a01b0385169063150b7a0290614c4c903390899088908890600401615a96565b602060405180830381600087803b158015614c6657600080fd5b505af1925050508015614c96575060408051601f3d908101601f19168201909252614c9391810190615887565b60015b614d3b573d808015614cc4576040519150601f19603f3d011682016040523d82523d6000602084013e614cc9565b606091505b508051614d335760405162461bcd60e51b815260206004820152603260248201527f4552433732313a207472616e7366657220746f206e6f6e20455243373231526560448201527131b2b4bb32b91034b6b83632b6b2b73a32b960711b6064820152608401610a5c565b805181602001fd5b6001600160e01b031916630a85bd0160e11b149050613fdc565b506001949350505050565b60006001614d6d846119cf565b614d779190615e33565b600083815260086020526040902054909150808214614dca576001600160a01b03841660009081526007602090815260408083208584528252808320548484528184208190558352600890915290208190555b5060009182526008602090815260408084208490556001600160a01b039094168352600781528383209183525290812055565b600954600090614e0f90600190615e33565b6000838152600a602052604081205460098054939450909284908110614e4557634e487b7160e01b600052603260045260246000fd5b906000526020600020015490508060098381548110614e7457634e487b7160e01b600052603260045260246000fd5b6000918252602080832090910192909255828152600a90915260408082208490558582528120556009805480614eba57634e487b7160e01b600052603160045260246000fd5b6001900381819060005260206000200160009055905550505050565b6000614ee1836119cf565b6001600160a01b039093166000908152600760209081526040808320868452825280832085905593825260089052919091209190915550565b6001600160a01b038216614f705760405162461bcd60e51b815260206004820181905260248201527f4552433732313a206d696e7420746f20746865207a65726f20616464726573736044820152606401610a5c565b6000818152600360205260409020546001600160a01b031615614fd55760405162461bcd60e51b815260206004820152601c60248201527f4552433732313a20746f6b656e20616c7265616479206d696e746564000000006044820152606401610a5c565b614fe160008383614ad2565b6001600160a01b038216600090815260046020526040812080546001929061500a908490615de8565b909155505060008181526003602052604080822080546001600160a01b0319166001600160a01b03861690811790915590518392907fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef908290a45050565b50805460008255906000526020600020908101906138a5919061510a565b82805461509290615e76565b90600052602060002090601f0160209004810192826150b457600085556150fa565b82601f106150cd57805160ff19168380011785556150fa565b828001600101855582156150fa579182015b828111156150fa5782518255916020019190600101906150df565b5061510692915061510a565b5090565b5b80821115615106576000815560010161510b565b600067ffffffffffffffff83111561513957615139615f0c565b61514c601f8401601f1916602001615d93565b905082815283838301111561516057600080fd5b828260208301376000602084830101529392505050565b803561518281615f22565b919050565b600082601f830112615197578081fd5b813560206151ac6151a783615dc4565b615d93565b80838252828201915082860187848660051b89010111156151cb578586fd5b855b858110156151f25781356151e081615f22565b845292840192908401906001016151cd565b5090979650505050505050565b600082601f83011261520f578081fd5b8135602061521f6151a783615dc4565b80838252828201915082860187848660061b890101111561523e578586fd5b855b858110156151f257604080838b031215615258578788fd5b615260615d6a565b83358152868401358782015285529385019390910190600101615240565b600082601f83011261528e578081fd5b8135602061529e6151a783615dc4565b80838252828201915082860187848660051b89010111156152bd578586fd5b855b858110156151f2578135845292840192908401906001016152bf565b600082601f8301126152eb578081fd5b612c0a8383356020850161511f565b60006060828403121561530b578081fd5b6040516060810181811067ffffffffffffffff8211171561532e5761532e615f0c565b6040528235815290508061534460208401615361565b602082015261535560408401615361565b60408201525092915050565b803560ff8116811461518257600080fd5b600060208284031215615383578081fd5b8135612c0a81615f22565b600080604083850312156153a0578081fd5b82356153ab81615f22565b915060208301356153bb81615f22565b809150509250929050565b6000806000606084860312156153da578081fd5b83356153e581615f22565b925060208401356153f581615f22565b929592945050506040919091013590565b6000806000806080858703121561541b578182fd5b843561542681615f22565b9350602085013561543681615f22565b925060408501359150606085013567ffffffffffffffff811115615458578182fd5b8501601f81018713615468578182fd5b6154778782356020840161511f565b91505092959194509250565b60008060408385031215615495578182fd5b82356154a081615f22565b915060208301356153bb81615f37565b6000806000806000806000610120888a0312156154cb578485fd5b6154d488615177565b9650602088013567ffffffffffffffff808211156154f0578687fd5b6154fc8b838c016152db565b975060408a0135915080821115615511578687fd5b61551d8b838c016152db565b965061552c8b60608c016152fa565b955060c08a0135915080821115615541578485fd5b61554d8b838c0161527e565b945060e08a0135915080821115615562578384fd5b5061556f8a828b016151ff565b925050610100880135905092959891949750929550565b600080600080600080600080610140898b0312156155a2578182fd5b6155ab89615177565b9750602089013567ffffffffffffffff808211156155c7578384fd5b6155d38c838d016152db565b985060408b01359150808211156155e8578384fd5b6155f48c838d016152db565b97506156038c60608d016152fa565b965060c08b0135915080821115615618578384fd5b6156248c838d0161527e565b955060e08b0135915080821115615639578384fd5b506156468b828c016151ff565b935050610100890135915061012089013590509295985092959890939650565b60008060408385031215615678578182fd5b823561568381615f22565b946020939093013593505050565b6000806000806000806000806000806101208b8d0312156156b0578384fd5b8a356156bb81615f22565b995060208b0135985060408b01356156d281615f22565b975060608b013567ffffffffffffffff808211156156ee578586fd5b818d0191508d601f830112615701578586fd5b81358181111561570f578687fd5b8e6020828501011115615720578687fd5b60208301995080985050505061573860808c01615177565b945061574660a08c01615177565b935060c08b0135925061575b60e08c01615177565b91506101008b013590509295989b9194979a5092959850565b60008060008060808587031215615789578182fd5b843561579481615f22565b935060208501359250604085013567ffffffffffffffff808211156157b7578384fd5b6157c388838901615187565b935060608701359150808211156157d8578283fd5b506154778782880161527e565b6000806000606084860312156157f9578081fd5b833567ffffffffffffffff80821115615810578283fd5b61581c87838801615187565b94506020860135915080821115615831578283fd5b5061583e8682870161527e565b925050604084013590509250925092565b600060208284031215615860578081fd5b8151612c0a81615f37565b60006020828403121561587c578081fd5b8135612c0a81615f45565b600060208284031215615898578081fd5b8151612c0a81615f45565b6000602082840312156158b4578081fd5b8151612c0a81615f22565b6000602082840312156158d0578081fd5b5035919050565b600080604083850312156158e9578182fd5b8251915060208084015167ffffffffffffffff811115615907578283fd5b8401601f81018613615917578283fd5b80516159256151a782615dc4565b80828252848201915084840189868560051b8701011115615944578687fd5b8694505b83851015615966578051835260019490940193918501918501615948565b5080955050505050509250929050565b60008060408385031215615988578182fd5b50508035926020909101359150565b6000815180845260208085019450808401835b838110156159cf5781516001600160a01b0316875295820195908201906001016159aa565b509495945050505050565b6000815180845260208085019450808401835b838110156159cf578151875295820195908201906001016159ed565b60008151808452615a21816020860160208601615e4a565b601f01601f19169290920160200192915050565b60008351615a47818460208801615e4a565b835190830190615a5b818360208801615e4a565b01949350505050565b6001600160a01b0384168152606060208201526000615a866060830185615a09565b9050826040830152949350505050565b60006001600160a01b03808716835280861660208401525083604083015260806060830152615ac86080830184615a09565b9695505050505050565b60006101a06001600160a01b038e16835260208181850152615af68285018f615a09565b9150604084830381860152615b0b838f615a09565b8d51606087015260208e015160ff908116608088015260408f01511660a087015292508b60c08601528a60e0860152848303610100860152615b4d838b6159da565b8581036101208701528951808252838b01945090830190855b81811015615b8b57855180518452850151858401529484019491830191600101615b66565b505088610140870152858103610160870152615ba78189615997565b945050505050615bc36101808301846001600160a01b03169052565b9c9b505050505050505050505050565b6001600160a01b0385168152608060208201526000615bf56080830186615a09565b6040830194909452506060015292915050565b6000610100808352615c1c8184018c615997565b90508960208401526001600160a01b03808a1660408501528382036060850152615c46828a615a09565b978116608085015295861660a0840152505060c081019290925290911660e090910152949350505050565b6020810160078310615c9357634e487b7160e01b600052602160045260246000fd5b91905290565b602081526000612c0a6020830184615a09565b828152604060208201526000613fdc6040830184615997565b838152606060208201526000615a866060830185615997565b6000604082018483526020604081850152818551808452606093508386019150828701855b82811015615d4357615d338483518051825260ff602082015116602083015260ff60408201511660408301525050565b9285019290840190600101615d03565b509198975050505050505050565b828152604060208201526000613fdc60408301846159da565b6040805190810167ffffffffffffffff81118282101715615d8d57615d8d615f0c565b60405290565b604051601f8201601f1916810167ffffffffffffffff81118282101715615dbc57615dbc615f0c565b604052919050565b600067ffffffffffffffff821115615dde57615dde615f0c565b5060051b60200190565b60008219821115615dfb57615dfb615ee0565b500190565b600082615e0f57615e0f615ef6565b500490565b6000816000190483118215151615615e2e57615e2e615ee0565b500290565b600082821015615e4557615e45615ee0565b500390565b60005b83811015615e65578181015183820152602001615e4d565b83811115612b155750506000910152565b600181811c90821680615e8a57607f821691505b60208210811415615eab57634e487b7160e01b600052602260045260246000fd5b50919050565b6000600019821415615ec557615ec5615ee0565b5060010190565b600082615edb57615edb615ef6565b500690565b634e487b7160e01b600052601160045260246000fd5b634e487b7160e01b600052601260045260246000fd5b634e487b7160e01b600052604160045260246000fd5b6001600160a01b03811681146138a557600080fd5b80151581146138a557600080fd5b6001600160e01b0319811681146138a557600080fdfea2646970667358221220a0c38f84704324d01955a22d600b56c9e2dabc8dc9da16db8bb03b6308f905c264736f6c63430008040033"

DEPLOYER_ADDRESS = "0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266"
CONTRACT_ADDRESS = "0x5FbDB2315678afecb367f032d93F642f64180aa3"
AGENT_REGISTRY = "0xe7f1725E7734CE288F8367e1Bb143E90bb3F0512"
# REGISTRIES_MANAGER = "0x9fE46736679d2D9a65F0992F2272dE9f3c7fa6e0"
# OWNER_COMPONENTS_AND_AGENTS = "0x8626f6940E2eb28930eFb4CeF49B2d1F2C9C1199"

ADDRESS_ONE = "0x70997970c51812dc3a010c7d01b50e0d17dc79c8"
ADDRESS_TWO = "0x3c44cdddb6a900fa2b585dd299e03d12fa4293bc"
ADDRESS_THREE = "0x90f79bf6eb2c4f870365e785982e1f101e93b906"
ADDRESS_FOUR = "0x15d34AAf54267DB7D7c367839AAf71A00a2C6A65"

NONCE = 0
CHAIN_ID = 31337


class BaseServiceRegistryContractTest(BaseGanacheContractTest):

    contract: ServiceRegistryContract
    ledger_identifier = EthereumCrypto.identifier
    contract_address = CONTRACT_ADDRESS
    contract_directory = Path(
        ROOT_DIR, "packages", PUBLIC_ID.author, "contracts", PUBLIC_ID.name
    )

    GAS: int = 10 ** 10
    DEFAULT_MAX_FEE_PER_GAS: int = 10 ** 10
    DEFAULT_MAX_PRIORITY_FEE_PER_GAS: int = 10 ** 10

    @classmethod
    def deployment_kwargs(cls) -> Dict[str, Any]:
        """Contract deployment kwargs"""

        _name: str = "TestServiceRegistry"
        _symbol: str = "OLA"
        _agentRegistry: Address = Web3.toChecksumAddress(AGENT_REGISTRY)
        _gnosisSafeL2: Address = Web3.toChecksumAddress(ADDRESS_TWO)
        _gnosisSafeProxyFactory: Address = Web3.toChecksumAddress(ADDRESS_THREE)

        return dict(
            _name=_name,
            _symbol=_symbol,
            _agentRegistry=_agentRegistry,
            _gnosisSafeL2=_gnosisSafeL2,
            _gnosisSafeProxyFactory=_gnosisSafeProxyFactory,
            gas=cls.GAS,
        )

    def create_dummy_service(self) -> bool:
        """Create dummy service"""

        owner: Address = self.key_pairs()[0][0]
        name: str = "dummy_service"
        description: str = "description"
        config_hash: ConfigHash = (b"config_hash", 8, 8)
        agent_ids: List[int] = [1, ]
        agent_params: AgentParams = [(256, 256), ]
        threshold: int = 0

        kwargs = dict(
            owner=owner,
            name=name,
            description=description,
            configHash=config_hash,
            agentIds=agent_ids,
            agentParams=agent_params,
            threshold=threshold,
        )

        success = self.contract.contract_method_call(
            self.ledger_api, "createService", **kwargs
        )

        return cast(bool, success)


class TestServiceRegistryContract(BaseServiceRegistryContractTest):
    """Test Service Registry Contract"""

    def test_deployment(self) -> None:
        """Test deployment"""

        expected_keys = {'gas', 'chainId', 'value', 'nonce', 'maxFeePerGas', 'maxPriorityFeePerGas', 'data', 'from'}

        tx = self.contract.get_deploy_transaction(
            ledger_api=self.ledger_api,
            deployer_address=str(self.deployer_crypto.address),
            **self.deployment_kwargs(),
        )

        assert isinstance(tx, dict)
        assert len(tx) == 8
        assert not expected_keys.symmetric_difference(tx)
        assert tx['data'].startswith("0x")

    def test_verify_contract(self) -> None:
        """Run verify test."""

        assert self.contract_address is not None
        result = self.contract.verify_contract(
            ledger_api=self.ledger_api,
            contract_address=self.contract_address,
        )

        assert result == DEPLOYED_BYTECODE

    # def test_get_service_info(self) -> None:
    #     """Test service info retrieval"""
    #
    #     service_id: int = 1  # contract counter increments before assignment
    #
    #     assert self.contract_address is not None
    #     assert self.create_dummy_service()
    #
    #     service_info = self.contract.get_service_info(
    #         ledger_api=self.ledger_api,
    #         contract_address=self.contract_address,
    #         service_id=service_id,
    #     )
    #
    #     assert service_info['service_id'] == service_id

    def test_get_service_info(self) -> None:

        owner: Address = self.key_pairs()[0][0]
        name: str = "dummy_service"
        description: str = "description"
        config_hash: ConfigHash = (b"config_hash", 8, 8)
        threshold: int = 0
        num_agent_ids: int = 1
        agent_ids: List[int] = [1, ]
        agent_params: List = [(256, 256), ]
        num_agent_instances: int = 1
        agent_instances: List[Address] = [ADDRESS_ONE, ]
        address: Address = ADDRESS_ONE

        result = dict(
            owner=owner,
            name=name,
            description=description,
            config_hash=config_hash,
            threshold=threshold,
            num_agent_ids=num_agent_ids,
            agent_ids=agent_ids,
            agent_params=agent_params,
            num_agent_instances=num_agent_instances,
            agent_instances=agent_instances,
            address=address,
        )

        with mock.patch.object(
                self.ledger_api.api.manager, "request_blocking", return_value=CHAIN_ID
        ):
            with mock.patch.object(
                    self.ledger_api.api.manager, "call_contract_function", return_value=result
            ):
                service_info = self.contract.get_service_info(
                    ledger_api=self.ledger_api,
                    contract_address=self.contract_address,
                    service_id=1,
                )

        logging.error(service_info)


